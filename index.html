<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEARN-360-EXPERTISE | Fee Management System</title>
    
    <!-- External Libraries (CDNs) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.css"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary: #1e3a8a; /* Royal Blue from Receipt */
            --primary-dark: #11255a;
            --accent: #0ea5e9;
            --success: #10b981;
            --danger: #ef4444;
            --bg-light: #f1f5f9;
            --bg-dark: #0f172a;
            --glass-light: rgba(255, 255, 255, 0.95);
            --glass-dark: rgba(30, 41, 59, 0.95);
            --text-light: #1e293b;
            --text-dark: #f8fafc;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --sidebar-width: 260px;
        }

        [data-theme="dark"] {
            --bg-light: #020617;
            --glass-light: rgba(15, 23, 42, 0.95);
            --text-light: #f1f5f9;
            --text-dark: #e2e8f0;
            --shadow: 0 10px 30px rgba(0,0,0,0.5);
            color: white;
        }

        * { box-sizing: border-box; transition: background 0.3s, color 0.3s; }
        body { font-family: 'Outfit', sans-serif; margin: 0; background: var(--bg-light); overflow-x: hidden; }

        /* ================= HELPERS ================= */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 10px; }
        .p-4 { padding: 20px; }
        
        /* ================= AUTH OVERLAY ================= */
        #auth-overlay {
            position: fixed; inset: 0; background: linear-gradient(135deg, #1e3a8a, #0ea5e9);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
        }
        .login-card {
            background: white; padding: 40px; border-radius: 20px; width: 350px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center;
        }
        .login-card h2 { color: var(--primary); margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 0.8rem; font-weight: 700; color: #64748b; margin-bottom: 5px; }
        .input-group input { 
            width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: inherit;
        }
        .btn-primary {
            width: 100%; background: var(--primary); color: white; border: none; padding: 12px;
            border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1rem;
        }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }

        /* ================= MAIN LAYOUT ================= */
        #app-container { display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width); background: var(--glass-light);
            border-right: 1px solid rgba(0,0,0,0.05);
            display: flex; flex-direction: column; position: fixed; height: 100%;
            backdrop-filter: blur(10px); z-index: 100;
        }
        .brand { padding: 20px; font-size: 1.2rem; font-weight: 800; color: var(--primary); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .nav-links { flex: 1; padding: 20px 0; list-style: none; margin: 0; }
        .nav-item {
            padding: 15px 25px; cursor: pointer; color: #64748b; font-weight: 600;
            display: flex; align-items: center; gap: 12px;
        }
        .nav-item:hover, .nav-item.active { background: rgba(30, 58, 138, 0.05); color: var(--primary); border-right: 4px solid var(--primary); }
        .nav-item i { width: 20px; text-align: center; }

        /* Content Area */
        .main-content {
            flex: 1; margin-left: var(--sidebar-width); padding: 30px;
            overflow-y: auto;
        }
        
        /* Top Bar */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;
        }
        .welcome-text h2 { margin: 0; color: var(--text-light); }
        .welcome-text p { margin: 5px 0 0; color: #64748b; font-size: 0.9rem; }
        .user-actions { display: flex; gap: 15px; align-items: center; }
        .action-btn { background: white; border: 1px solid #e2e8f0; padding: 10px; border-radius: 50%; cursor: pointer; color: #64748b; }

        /* Dashboard Cards */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: var(--glass-light); padding: 20px; border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid rgba(255,255,255,0.1);
        }
        .stat-card h3 { margin: 0 0 10px; font-size: 0.9rem; color: #64748b; text-transform: uppercase; }
        .stat-card .value { font-size: 1.8rem; font-weight: 800; color: var(--primary); }
        
        /* Charts Area */
        .charts-container {
            display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px;
        }
        .chart-box { background: white; padding: 20px; border-radius: 16px; height: 350px; }

        /* Tables */
        .data-table-container {
            background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #f1f5f9; }
        th { background: #f8fafc; font-weight: 700; color: #475569; font-size: 0.85rem; text-transform: uppercase; }
        td { color: #334155; font-size: 0.95rem; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef9c3; color: #854d0e; }

        /* Forms */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }

        /* Toast */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; }
        .toast {
            background: white; padding: 15px 25px; border-radius: 8px; margin-bottom: 10px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-left: 5px solid var(--primary);
            display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); transition: 0.3s; }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 15px; }
            .charts-container { grid-template-columns: 1fr; }
        }

        /* ================= PRINT STYLES (FROM RECEIPT PROMPT) ================= */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            @page { size: A4; margin: 0; }

            .receipt-copy {
                width: 210mm; height: 148mm; padding: 5mm 10mm;
                display: flex; flex-direction: column; position: relative; box-sizing: border-box;
            }
            .cut-line {
                position: absolute; bottom: 0; left: 0; width: 100%;
                border-bottom: 2px dashed #999; text-align: center; font-size: 10px; color: #666; line-height: 0;
            }
            .cut-line span { background: #fff; padding: 0 10px; position: relative; top: 4px; }
            .main-border {
                border: 3px double var(--primary); height: 100%; padding: 10px 15px;
                position: relative; border-radius: 6px; display: flex; flex-direction: column;
            }
            .r-header {
                display: flex; justify-content: space-between; align-items: center;
                border-bottom: 2px solid var(--primary); padding-bottom: 8px; margin-bottom: 8px;
            }
            .logo-section h2 { margin: 0; font-size: 1.6rem; font-weight: 800; color: var(--primary); text-transform: uppercase; }
            .address-box { font-size: 0.85rem; color: #000; margin-top: 4px; line-height: 1.3; }
            .receipt-meta { text-align: right; background: #f8fafc; border: 1px solid var(--primary); padding: 5px 8px; border-radius: 4px; }
            .copy-label { background: var(--primary); color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 2px; text-transform: uppercase; font-weight: 700; display: inline-block; margin-bottom: 4px; }
            .meta-row { font-size: 0.85rem; font-weight: 700; color: #333; }
            .details-grid {
                display: grid; grid-template-columns: 1.2fr 1fr; gap: 15px;
                background: #f1f5f9; padding: 10px; border-radius: 6px; border: 1px solid #e2e8f0; margin-bottom: 10px;
            }
            .d-row { display: flex; margin-bottom: 2px; font-size: 0.9rem; }
            .d-lbl { font-weight: 600; color: #64748b; width: 80px; }
            .d-val { font-weight: 700; color: #000; flex: 1; }
            .fee-table { width: 100%; border-collapse: collapse; flex: 1; }
            .fee-table th { background: var(--primary); color: white; padding: 5px; text-align: left; font-size: 0.8rem; text-transform: uppercase; }
            .fee-table td { padding: 6px 5px; border-bottom: 1px solid #ccc; font-size: 0.9rem; font-weight: 600; }
            .total-row td { background: #e0e7ff; color: var(--primary); font-size: 1rem; border-top: 2px solid var(--primary); font-weight: 800; }
            .words-row { font-style: italic; font-size: 0.8rem; margin: 5px 0 10px 0; }
            .footer-section { display: flex; justify-content: space-between; align-items: flex-end; margin-top: auto; }
            .terms { font-size: 0.7rem; color: #555; max-width: 60%; line-height: 1.2; }
            .sign-box { text-align: center; }
            .sign-line { border-top: 2px solid #000; width: 120px; margin-top: 35px; font-weight: 700; font-size: 0.8rem; padding-top: 2px; }
            .stamp {
                position: absolute; bottom: 80px; right: 150px; border: 3px solid #ef4444; color: #ef4444;
                font-size: 1.5rem; font-weight: 900; text-transform: uppercase; padding: 5px 20px; border-radius: 8px;
                transform: rotate(-15deg); opacity: 0.3; z-index: 0; pointer-events: none;
            }
            .watermark {
                position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
                font-size: 5rem; font-weight: 900; color: rgba(30, 58, 138, 0.03); z-index: 0;
            }
        }
    </style>
</head>
<body>

    <!-- 1. AUTH OVERLAY -->
    <div id="auth-overlay">
        <div class="login-card">
            <h2><i class="fas fa-university"></i> LEARN-360</h2>
            <p>Secure System Access</p>
            <form id="login-form">
                <div class="input-group">
                    <label>Username</label>
                    <input type="text" id="username" placeholder="admin" required>
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="admin123" required>
                </div>
                <button type="submit" class="btn-primary">Login to Dashboard</button>
            </form>
            <p style="font-size:0.75rem; color:#ccc; margin-top:15px;">Default: admin / admin123</p>
        </div>
    </div>

    <!-- 2. MAIN APP -->
    <div id="app-container" class="hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="brand"><i class="fas fa-graduation-cap"></i> LEARN 360+</div>
            <ul class="nav-links">
                <li class="nav-item active" onclick="router.navigate('dashboard')"><i class="fas fa-home"></i> Dashboard</li>
                <li class="nav-item" onclick="router.navigate('receipts')"><i class="fas fa-file-invoice-dollar"></i> Receipts</li>
                <li class="nav-item" onclick="router.navigate('students')"><i class="fas fa-users"></i> Students</li>
                <li class="nav-item" onclick="router.navigate('fees')"><i class="fas fa-tags"></i> Fee Structure</li>
                <li class="nav-item" onclick="router.navigate('reports')"><i class="fas fa-chart-line"></i> Analytics</li>
                <li class="nav-item" onclick="router.navigate('settings')"><i class="fas fa-cog"></i> Settings</li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="welcome-text">
                    <h2 id="page-title">Dashboard</h2>
                    <p id="current-date">Fetching date...</p>
                </div>
                <div class="user-actions">
                    <button class="action-btn" onclick="app.toggleTheme()"><i class="fas fa-moon"></i></button>
                    <button class="action-btn" onclick="auth.logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </div>

            <!-- Sections -->
            <div id="view-dashboard" class="view-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Today's Collection</h3>
                        <div class="value" id="kpi-today">₹0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Monthly Collection</h3>
                        <div class="value" id="kpi-month">₹0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Students</h3>
                        <div class="value" id="kpi-students">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Pending Dues</h3>
                        <div class="value" style="color:var(--danger)">--</div>
                    </div>
                </div>
                <div class="charts-container">
                    <div class="chart-box">
                        <canvas id="revenueChart"></canvas>
                    </div>
                    <div class="chart-box">
                        <canvas id="modeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- RECEIPT FORM SECTION -->
            <div id="view-receipts" class="view-section hidden">
                <div class="stat-card">
                    <h3 style="margin-bottom:20px; font-size:1.2rem; color:var(--primary);">Generate New Receipt (Alt+N)</h3>
                    <form id="receipt-form">
                        <div class="form-grid">
                            <div class="input-group">
                                <label>Date</label>
                                <input type="date" id="r-date" required>
                            </div>
                            <div class="input-group">
                                <label>Student Name</label>
                                <input type="text" id="r-name" placeholder="Search or Enter Name" required>
                            </div>
                             <div class="input-group">
                                <label>Class</label>
                                <select id="r-class" onchange="dataManager.fillFee()" required>
                                    <option value="">Select Class</option>
                                    <!-- Populated dynamically -->
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Father's Name</label>
                                <input type="text" id="r-father" required>
                            </div>
                            <div class="input-group">
                                <label>Mobile</label>
                                <input type="number" id="r-mobile" required>
                            </div>
                            <div class="input-group">
                                <label>Fee Amount (₹)</label>
                                <input type="number" id="r-amount" required>
                            </div>
                            <div class="input-group">
                                <label>Payment Mode</label>
                                <select id="r-mode">
                                    <option value="Cash">Cash</option>
                                    <option value="UPI">UPI</option>
                                    <option value="Bank">Bank Transfer</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex gap-2" style="margin-top:20px;">
                            <button type="button" class="btn-primary" onclick="receiptManager.generateAndPrint()"><i class="fas fa-print"></i> Save & Print (Alt+P)</button>
                            <button type="reset" class="action-btn">Reset</button>
                        </div>
                    </form>
                </div>

                <h3 style="margin-top:30px;">Recent Receipts</h3>
                <div class="data-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Date</th>
                                <th>Student</th>
                                <th>Class</th>
                                <th>Amount</th>
                                <th>Mode</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="receipt-table-body">
                            <!-- Data -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- FEES SECTION -->
            <div id="view-fees" class="view-section hidden">
                <div class="stat-card" style="max-width:500px">
                    <h3>Update Fee Structure</h3>
                    <form id="fee-update-form">
                        <div class="input-group">
                            <label>Select Class</label>
                            <select id="f-class">
                                <option value="Nursery">Nursery</option>
                                <option value="Primary">Primary</option>
                                <option value="Secondary">Secondary</option>
                                <option value="Higher Secondary">Higher Secondary</option>
                                <option value="B.Tech">B.Tech</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>New Amount (₹)</label>
                            <input type="number" id="f-amount" required>
                        </div>
                        <button type="button" onclick="dataManager.updateFee()" class="btn-primary">Update Fee</button>
                    </form>
                </div>
                <div class="stat-card" style="margin-top:20px;">
                    <h3>Current Structure</h3>
                    <div id="current-fee-display" class="flex flex-col gap-2"></div>
                </div>
            </div>

            <!-- SETTINGS / AUDIT -->
            <div id="view-settings" class="view-section hidden">
                <div class="stat-card">
                    <h3>Data Management</h3>
                    <div class="flex gap-2">
                        <button onclick="dataManager.exportData()" class="btn-primary" style="background:#10b981"><i class="fas fa-file-excel"></i> Export Excel</button>
                        <button onclick="dataManager.clearData()" class="btn-primary" style="background:#ef4444"><i class="fas fa-trash"></i> Factory Reset</button>
                    </div>
                </div>
                <h3 style="margin-top:20px;">Audit Log</h3>
                <div class="data-table-container" style="max-height: 400px; overflow-y:auto;">
                    <table>
                        <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Details</th></tr></thead>
                        <tbody id="audit-log-body"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Students View (Placeholder) -->
            <div id="view-students" class="view-section hidden">
                <h3>Registered Students</h3>
                <div class="data-table-container">
                     <table><thead><tr><th>Name</th><th>Class</th><th>Father</th><th>Mobile</th></tr></thead><tbody id="student-list"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- 4. HIDDEN PRINT AREA (Using the Premium Layout) -->
    <div id="print-area">
        <!-- Template injected by JS based on prompt -->
         <div class="receipt-copy">
            <div class="main-border">
                <div class="watermark">OFFICE COPY</div>
                <div class="stamp">PAID</div>
                <div class="r-header">
                    <div class="logo-section">
                        <h2>Learn 360+ Expertise</h2>
                        <div class="address-box">
                            <div><strong>Resources Tuition Centre, Pilani</strong></div>
                            <div>Sarawagi Dharamshala, Near Jherli Road</div>
                            <div><i class="fas fa-phone-alt"></i> 9667683378, 9694449220</div>
                        </div>
                    </div>
                    <div class="receipt-meta">
                        <span class="copy-label">Office Copy</span>
                        <div class="meta-row">No: <span class="pr-no">--</span></div>
                        <div class="meta-row">Date: <span class="pr-date">--</span></div>
                    </div>
                </div>
                <div class="details-grid">
                    <div>
                        <div class="d-row"><span class="d-lbl">Name:</span> <span class="d-val pr-name">--</span></div>
                        <div class="d-row"><span class="d-lbl">Class:</span> <span class="d-val pr-cls">--</span></div>
                        <div class="d-row"><span class="d-lbl">Father:</span> <span class="d-val pr-fname">--</span></div>
                    </div>
                    <div>
                        <div class="d-row"><span class="d-lbl">Mobile:</span> <span class="d-val pr-mob">--</span></div>
                        <div class="d-row"><span class="d-lbl">Mode:</span> <span class="d-val pr-mode">--</span></div>
                    </div>
                </div>
                <table class="fee-table">
                    <thead><tr><th>Description</th><th style="text-align:right">Amount (₹)</th></tr></thead>
                    <tbody>
                        <tr><td>Tuition / Coaching Fees</td><td style="text-align:right" class="pr-amt">0.00</td></tr>
                        <tr><td style="padding:15px 0;"></td><td></td></tr>
                        <tr class="total-row"><td>TOTAL RECEIVED</td><td style="text-align:right" class="pr-amt">0.00</td></tr>
                    </tbody>
                </table>
                <div class="words-row">Amount in words: <span class="pr-words">Zero Rupees Only</span></div>
                <div class="footer-section">
                    <div class="terms">
                        <strong>Terms & Conditions:</strong><br>1. Fees once paid is strictly non-refundable.<br>2. This is a computer generated receipt.
                    </div>
                    <div class="sign-box"><div class="sign-line">Authorized Signatory</div></div>
                </div>
            </div>
            <div class="cut-line"><span><i class="fas fa-cut"></i> CUT HERE</span></div>
        </div>

        <!-- Copy 2 -->
        <div class="receipt-copy">
            <div class="main-border">
                <div class="watermark">PARENTS COPY</div>
                <div class="stamp">PAID</div>
                <div class="r-header">
                    <div class="logo-section">
                        <h2>Learn 360+ Expertise</h2>
                        <div class="address-box">
                            <div><strong>Resources Tuition Centre, Pilani</strong></div>
                            <div>Sarawagi Dharamshala, Near Jherli Road</div>
                        </div>
                    </div>
                    <div class="receipt-meta">
                        <span class="copy-label">Parents Copy</span>
                        <div class="meta-row">No: <span class="pr-no">--</span></div>
                        <div class="meta-row">Date: <span class="pr-date">--</span></div>
                    </div>
                </div>
                <div class="details-grid">
                    <div>
                        <div class="d-row"><span class="d-lbl">Name:</span> <span class="d-val pr-name">--</span></div>
                        <div class="d-row"><span class="d-lbl">Class:</span> <span class="d-val pr-cls">--</span></div>
                        <div class="d-row"><span class="d-lbl">Father:</span> <span class="d-val pr-fname">--</span></div>
                    </div>
                    <div>
                        <div class="d-row"><span class="d-lbl">Mobile:</span> <span class="d-val pr-mob">--</span></div>
                        <div class="d-row"><span class="d-lbl">Mode:</span> <span class="d-val pr-mode">--</span></div>
                    </div>
                </div>
                <table class="fee-table">
                    <thead><tr><th>Description</th><th style="text-align:right">Amount (₹)</th></tr></thead>
                    <tbody>
                        <tr><td>Tuition / Coaching Fees</td><td style="text-align:right" class="pr-amt">0.00</td></tr>
                        <tr><td style="padding:15px 0;"></td><td></td></tr>
                        <tr class="total-row"><td>TOTAL RECEIVED</td><td style="text-align:right" class="pr-amt">0.00</td></tr>
                    </tbody>
                </table>
                <div class="words-row">Amount in words: <span class="pr-words">Zero Rupees Only</span></div>
                <div class="footer-section">
                    <div class="terms"><strong>Terms & Conditions:</strong><br>1. Fees once paid is strictly non-refundable.</div>
                    <div class="sign-box"><div class="sign-line">Authorized Signatory</div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT LOGIC -->
    <script>
        // --- 1. UTILITIES ---
        const Utils = {
            formatCurrency: (num) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(num),
            numToWords: (num) => {
                const a = ['','One ','Two ','Three ','Four ', 'Five ','Six ','Seven ','Eight ','Nine ','Ten ','Eleven ','Twelve ','Thirteen ','Fourteen ','Fifteen ','Sixteen ','Seventeen ','Eighteen ','Nineteen '];
                const b = ['', '', 'Twenty','Thirty','Forty','Fifty', 'Sixty','Seventy','Eighty','Ninety'];
                if ((num = num.toString()).length > 9) return 'overflow';
                const n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
                if (!n) return; let str = '';
                str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'Crore ' : '';
                str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'Lakh ' : '';
                str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'Thousand ' : '';
                str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'Hundred ' : '';
                str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
                return str ? str + "Rupees Only" : "Zero Rupees";
            },
            showToast: (msg, type = 'success') => {
                const div = document.createElement('div');
                div.className = 'toast';
                div.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}" style="color:${type==='success'?'var(--success)':'var(--danger)'}"></i> ${msg}`;
                document.getElementById('toast-container').appendChild(div);
                setTimeout(() => div.remove(), 3000);
            }
        };

        // --- 2. DATA STORE (Encrypted) ---
        class Store {
            constructor() {
                this.init();
            }
            init() {
                if(!localStorage.getItem('l360_data')) {
                    const initialData = {
                        fees: { "Nursery": 5000, "Primary": 7000, "Secondary": 12000, "Higher Secondary": 15000, "B.Tech": 20000 },
                        receipts: [],
                        students: [],
                        logs: []
                    };
                    this.save(initialData);
                }
            }
            get() {
                try {
                    const raw = localStorage.getItem('l360_data');
                    return JSON.parse(atob(raw));
                } catch(e) { console.error("Data Corruption"); return {}; }
            }
            save(data) {
                localStorage.setItem('l360_data', btoa(JSON.stringify(data)));
            }
            log(action, details) {
                const data = this.get();
                data.logs.unshift({ time: new Date().toLocaleString(), user: auth.user, action, details });
                this.save(data);
                dataManager.renderLogs();
            }
        }
        const store = new Store();

        // --- 3. AUTH & SESSION ---
        const auth = {
            user: null,
            timer: null,
            login: (u, p) => {
                if(u === 'admin' && p === 'admin123') {
                    auth.user = 'Super Admin';
                    auth.startSession();
                    document.getElementById('auth-overlay').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    router.navigate('dashboard');
                    Utils.showToast('Welcome back, Admin');
                } else {
                    Utils.showToast('Invalid Credentials', 'error');
                }
            },
            logout: () => {
                auth.user = null;
                clearInterval(auth.timer);
                location.reload();
            },
            startSession: () => {
                let idle = 0;
                setInterval(() => { idle++; if(idle > 600) auth.logout(); }, 1000); // 10 min auto lock
                document.onmousemove = document.onkeypress = () => { idle = 0; };
            }
        };

        // --- 4. DATA MANAGER ---
        const dataManager = {
            renderDashboard: () => {
                const data = store.get();
                // KPIs
                const today = new Date().toISOString().split('T')[0];
                const todayColl = data.receipts.filter(r => r.date === today).reduce((sum, r) => sum + parseFloat(r.amount), 0);
                const totalColl = data.receipts.reduce((sum, r) => sum + parseFloat(r.amount), 0);
                
                document.getElementById('kpi-today').innerText = Utils.formatCurrency(todayColl);
                document.getElementById('kpi-month').innerText = Utils.formatCurrency(totalColl); // Simplified month for demo
                document.getElementById('kpi-students').innerText = data.receipts.length; // Unique students logic ideally

                // Charts
                dataManager.renderCharts(data.receipts);
            },
            renderCharts: (receipts) => {
                const ctx1 = document.getElementById('revenueChart').getContext('2d');
                const ctx2 = document.getElementById('modeChart').getContext('2d');
                
                // Destroy old charts if exist (simplified check)
                if(window.myChart1) window.myChart1.destroy();
                if(window.myChart2) window.myChart2.destroy();

                window.myChart1 = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: receipts.slice(-10).map(r => r.date),
                        datasets: [{ label: 'Fees Collected', data: receipts.slice(-10).map(r => r.amount), borderColor: '#1e3a8a', tension: 0.4 }]
                    }
                });

                const modes = {'Cash':0, 'UPI':0, 'Bank':0};
                receipts.forEach(r => modes[r.mode] = (modes[r.mode] || 0) + 1);
                
                window.myChart2 = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(modes),
                        datasets: [{ data: Object.values(modes), backgroundColor: ['#1e3a8a', '#0ea5e9', '#10b981'] }]
                    }
                });
            },
            fillFee: () => {
                const cls = document.getElementById('r-class').value;
                const fees = store.get().fees;
                if(fees[cls]) document.getElementById('r-amount').value = fees[cls];
            },
            updateFee: () => {
                const cls = document.getElementById('f-class').value;
                const amt = document.getElementById('f-amount').value;
                if(!amt) return;
                
                const data = store.get();
                data.fees[cls] = parseInt(amt);
                store.save(data);
                store.log('Fee Update', `Changed ${cls} to ${amt}`);
                Utils.showToast('Fee Structure Updated');
                dataManager.renderFeeView();
            },
            renderFeeView: () => {
                const fees = store.get().fees;
                const container = document.getElementById('current-fee-display');
                container.innerHTML = Object.entries(fees).map(([k, v]) => 
                    `<div style="display:flex; justify-content:space-between; padding:10px; background:#fff; border-radius:8px;">
                        <span>${k}</span> <strong>${Utils.formatCurrency(v)}</strong>
                    </div>`
                ).join('');
                
                // Populate Select Dropdowns
                const options = Object.keys(fees).map(k => `<option value="${k}">${k}</option>`).join('');
                document.getElementById('r-class').innerHTML = `<option value="">Select Class</option>` + options;
            },
            renderLogs: () => {
                const logs = store.get().logs;
                document.getElementById('audit-log-body').innerHTML = logs.map(l => 
                    `<tr><td>${l.time}</td><td>${l.user}</td><td>${l.action}</td><td>${l.details}</td></tr>`
                ).join('');
            },
            exportData: () => {
                const wb = XLSX.utils.book_new();
                const data = store.get();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.receipts), "Receipts");
                XLSX.writeFile(wb, "Learn360_Data.xlsx");
                store.log('Export', 'Downloaded Excel Report');
            },
            clearData: () => {
                if(confirm("Are you sure? This cannot be undone.")) {
                    localStorage.removeItem('l360_data');
                    location.reload();
                }
            }
        };

        // --- 5. RECEIPT MANAGER ---
        const receiptManager = {
            generateAndPrint: () => {
                const form = document.getElementById('receipt-form');
                if(!form.checkValidity()) { form.reportValidity(); return; }

                // 1. Gather Data
                const rData = {
                    id: 'REC-' + (Math.floor(Math.random() * 9000) + 1000),
                    date: document.getElementById('r-date').value,
                    name: document.getElementById('r-name').value,
                    class: document.getElementById('r-class').value,
                    father: document.getElementById('r-father').value,
                    mobile: document.getElementById('r-mobile').value,
                    amount: document.getElementById('r-amount').value,
                    mode: document.getElementById('r-mode').value
                };

                // 2. Save to DB
                const data = store.get();
                data.receipts.unshift(rData);
                // Also add to simple student list if new
                if(!data.students.find(s => s.name === rData.name)) {
                    data.students.push({name: rData.name, class: rData.class, father: rData.father, mobile: rData.mobile});
                }
                store.save(data);
                store.log('New Receipt', `Generated ${rData.id} for ${rData.name}`);

                // 3. Populate Print Area
                const setTxt = (cls, val) => document.querySelectorAll(cls).forEach(el => el.textContent = val);
                
                // Format Date DD-MM-YYYY
                const [y, m, d] = rData.date.split('-');
                
                setTxt('.pr-no', rData.id);
                setTxt('.pr-date', `${d}-${m}-${y}`);
                setTxt('.pr-name', rData.name);
                setTxt('.pr-cls', rData.class);
                setTxt('.pr-fname', rData.father);
                setTxt('.pr-mob', rData.mobile);
                setTxt('.pr-mode', rData.mode);
                setTxt('.pr-amt', Utils.formatCurrency(rData.amount));
                setTxt('.pr-words', Utils.numToWords(Math.floor(rData.amount)));

                // 4. Print & Reset
                window.print();
                form.reset();
                Utils.showToast('Receipt Generated Successfully');
                receiptManager.renderList();
                dataManager.renderDashboard();
            },
            renderList: () => {
                const receipts = store.get().receipts;
                const html = receipts.slice(0, 10).map(r => 
                    `<tr>
                        <td><span class="badge badge-success">${r.id}</span></td>
                        <td>${r.date}</td>
                        <td><strong>${r.name}</strong></td>
                        <td>${r.class}</td>
                        <td>${Utils.formatCurrency(r.amount)}</td>
                        <td>${r.mode}</td>
                        <td><button class="action-btn" onclick="Utils.showToast('Reprint not implemented in demo', 'warning')"><i class="fas fa-print"></i></button></td>
                    </tr>`
                ).join('');
                document.getElementById('receipt-table-body').innerHTML = html;
            }
        };

        // --- 6. APP ROUTER & EVENTS ---
        const router = {
            navigate: (view) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${view}`).classList.remove('hidden');
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                event.currentTarget ? event.currentTarget.classList.add('active') : null;
                
                document.getElementById('page-title').innerText = view.charAt(0).toUpperCase() + view.slice(1);
                
                if(view === 'dashboard') dataManager.renderDashboard();
                if(view === 'receipts') receiptManager.renderList();
                if(view === 'fees') dataManager.renderFeeView();
                if(view === 'settings') dataManager.renderLogs();
                if(view === 'students') {
                     const st = store.get().students;
                     document.getElementById('student-list').innerHTML = st.map(s => `<tr><td>${s.name}</td><td>${s.class}</td><td>${s.father}</td><td>${s.mobile}</td></tr>`).join('');
                }
            }
        };

        const app = {
            toggleTheme: () => {
                const body = document.body;
                if(body.getAttribute('data-theme') === 'dark') {
                    body.removeAttribute('data-theme');
                } else {
                    body.setAttribute('data-theme', 'dark');
                }
            },
            init: () => {
                document.getElementById('current-date').innerText = new Date().toDateString();
                document.getElementById('r-date').valueAsDate = new Date();
                dataManager.renderFeeView(); // Init dropdowns
                
                // Keyboard Shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.altKey && e.key === 'n') { router.navigate('receipts'); document.getElementById('r-name').focus(); }
                    if (e.altKey && e.key === 'p') { receiptManager.generateAndPrint(); }
                });

                // Login Handler
                document.getElementById('login-form').onsubmit = (e) => {
                    e.preventDefault();
                    auth.login(document.getElementById('username').value, document.getElementById('password').value);
                };
            }
        };

        // Initialize
        app.init();
        
        // Auto Backup every 5 mins
        setInterval(() => store.save(store.get()), 300000);

    </script>
</body>
</html>
